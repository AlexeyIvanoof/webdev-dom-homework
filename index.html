<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul id="container" class="comments">
        <li class="comment" data-likeNumb="3" data-comment-text=" <Это будет первый комментарий на этой странице
  (Глеб Фокин)">
          <div class="comment-header">
            <div>Глеб Фокин</div>
            <div id="date">12.02.22 12:18</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              Это будет первый комментарий на этой странице
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span id="likes-counter" class="likes-counter">3</span>
              <button id="likebutton" class="like-button"></button>
            </div>
          </div>
          <div>
            <button id="delete-button" class="delete-button">Удалить комментарий</button>
          </div>
        </li>
        <li class="comment" data-likeNumb="75" data-comment-text="< Мне нравится как оформлена эта страница! ❤
  (Варвара Н.)">
          <div class="comment-header">
            <div>Варвара Н.</div>
            <div>13.02.22 19:22</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              Мне нравится как оформлена эта страница! ❤
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">75</span>
              <button id="likebutton-active-like" class="like-button -active-like"></button>
            </div>
          </div>
          <div>
            <button id="delete-button" class="delete-button">Удалить комментарий</button>
          </div>
        </li>
      </ul>
      <div class="add-form">
        <input
          id="add-form-name"
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          id="add-form-text"
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button id="add-form-button" class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script>
    "use strict";
    const buttonElement = document.getElementById("add-form-button");
    const newCommentElement = document.getElementById("container");
    const inputNameElement = document.getElementById("add-form-name");
    const commentsElement = document.getElementById("add-form-text");


    const commentElements = document.querySelectorAll(".comment");
    const initEventListeners = () => {
      const commentElements = document.querySelectorAll(".comment");
      for (const commentElement of commentElements) {
        commentElement.addEventListener("click", () => {
          // редактирование коментария дз-11
          let textItem = commentElement.dataset.commentText;
        if (textItem) {
        document.querySelector('#add-form-text').value = textItem;
      };
        });

        // активация лайка
        const likeButton = commentElement.querySelector(".like-button");
        const likesCounter = commentElement.querySelector(".likes-counter");
        const dataLikeNumb = parseInt(commentElement.getAttribute("data-likeNumb"));

        let liked = false;
        let likes = dataLikeNumb;

        if (likeButton.classList.contains("-active-like")) {
          liked = true;
        }

        likeButton.addEventListener("click", (event) => {
          event.stopPropagation();
          if (liked) {
            likes--;
          } else {
            likes++;
          }
          liked = !liked;
          likesCounter.textContent = likes;
          commentElement.setAttribute("data-likeNumb", likes);
          likeButton.classList.toggle("-active-like");
        });
      }
    };
    initEventListeners();

//формат даты
    const dateElement = document.getElementById("date");
    const myDate = new Date();
    const formatDate = (date) => {
      let data = date.getDate();
      let month = date.getMonth();
      let hour = date.getHours();
      let minute = date.getMinutes();

      if (data < 10) {
        data = "0" + data;
      }
      if (month < 10) {
        month = "0" + (month + 1);
      }
      if (hour < 10) {
        hour = "0" + hour;
      }
      return `${data}.${month}.${date.getFullYear().toString().substr(-2)} ${hour}:${minute}`;
    };
    dateElement.textContent = formatDate(myDate);

    
    let comments = [
      {
        author: {name:"Глеб Фокин"},
        text: "Это будет первый комментарий на этой странице", 
        date: "12.02.22 12:18",
        likes: 3,
        isLiked : false
      },
      {
        author: {name:"Варвара Н."},
        text: "Мне нравится как оформлена эта страница! ❤",
        date: "13.02.22 19:22",
        likes: 75,
        isLiked : true
      },
    ];

    const renderСomments = () => {
         const commentsHtml = comments.map((comment, id)=>{
          return`<li  class="comment"  data-likeNumb="${comment.likesCounter}"  data-comment-text="<${comment.text}
  (${comment.author.name})">
          <div class="comment-header">
            <div>${comment.author.name}</div>
            <div>${comment.date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${comment.text}
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${comment.likes}</span>
              <button class="like-button"></button>
            </div>
          </div>
          <div>
            <button data-id="${comment.id}" class="delete-button">Удалить комментарий</button>
          </div>
        </li>`
        })
        .join("");
      
         newCommentElement.innerHTML = commentsHtml;

         const initDeleteButtonsListeners = () => {
         const deleteButtonsElements = document.querySelectorAll(".delete-button");

        for (const deleteButtonElement of deleteButtonsElements) {
        deleteButtonElement.addEventListener("click", (event) => {
          event.stopPropagation();
          const id =  deleteButtonElement.dataset.id;
          fetch("https://wedev-api.sky.pro/api/v1/:aleksey-ivanov/comments" +id, {
        method: "DELETE",
      }).then(() => {
      getFetchPromise();
      renderСomments();
    });
          renderСomments();
        });
      }
    };
    initDeleteButtonsListeners();
    initEventListeners();
  };    
      renderСomments();

    const getFetchPromise = () => {
    const fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/:aleksey-ivanov/comments", {
      method: "GET"
    });

    // подписываемся на успешное завершение запроса с помощью then
    fetchPromise.then((response) => {
      // Запускаем преобразовываем "сырые" данные от API в json формат
      const jsonPromise = response.json();

      // Подписываемся на результат преобразования
      jsonPromise.then((responseData) => {
        const appComments = responseData.comments.map((comment) =>{
            return{
              name: comment.author.name,
              date: new Date(comment.data),
              text: comment.text,
              likes: comment.likes,
              isLiked : false
            }
          });
          comments = appComments;
        // получили данные и рендерим их в приложении
        comments = responseData.comments;
       renderСomments();
      });
    })
  };
     getFetchPromise();



      // добавление нового коментария
    buttonElement.addEventListener("click", () => {
  
      if (inputNameElement.value === "" || commentsElement.value === "") {
        return false;
      };
    
      fetch("https://wedev-api.sky.pro/api/v1/:aleksey-ivanov/comments", {
        method: "POST",
        body: JSON.stringify({
          name: inputNameElement.value,
          text:  commentsElement.value,
          date:  `${formatDate(myDate)}`,
        })
      }).then(() => {
      getFetchPromise();
      renderСomments();
    });
    renderСomments();
    inputNameElement.value = "";
  });
    console.log("It works!");
  </script>
</html>
